<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GarmentPay Hub</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://rfharywjzybciqiiovpx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJmaGFyeXdqenliY2lxaWlvdnB4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxMTY2NTYsImV4cCI6MjA3MzY5MjY1Nn0.M0nwkiUepqsUiR1yKj7i7Mg7WfmFG8JQ2n12yRitSqw";
    window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>
</head>
<body class="bg-slate-100 min-h-screen">
  <div class="max-w-6xl mx-auto p-6" id="app-root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;
    const supabase = window.supabaseClient;

    function Card({ title, children, extra }) {
      return (<div className="p-4 bg-white rounded-2xl shadow">
        <div className="flex items-center justify-between mb-2">
          <div className="font-semibold">{title}</div>{extra}
        </div>{children}</div>);
    }

    function Money({ children }) { return <span>Rp {Number(children||0).toLocaleString("id-ID")}</span>; }

    // ðŸ”¹ Ambil hash param dari URL (untuk reset password)
    function getHashParams() {
      const hash = window.location.hash.substring(1);
      return Object.fromEntries(new URLSearchParams(hash));
    }

    // ðŸ”¹ Form Reset Password
    function ResetPasswordView({ onDone }) {
      const [pw, setPw] = useState("");
      const [loading, setLoading] = useState(false);

      async function submit(e) {
        e.preventDefault();
        if (!pw || pw.length < 8) return alert("Password minimal 8 karakter.");
        setLoading(true);
        const { error } = await supabase.auth.updateUser({ password: pw });
        setLoading(false);
        if (error) return alert(error.message);
        alert("Password berhasil diubah. Silakan login kembali.");
        window.location.hash = "";
        onDone && onDone();
      }

      return (
        <div className="max-w-md mx-auto mt-6 p-6 bg-white rounded-2xl shadow">
          <div className="font-semibold mb-2">Set password baru</div>
          <form onSubmit={submit} className="space-y-3">
            <input
              type="password"
              className="border rounded-xl px-3 py-2 w-full"
              placeholder="Password baru (min 8)"
              value={pw}
              onChange={(e)=>setPw(e.target.value)}
            />
            <button disabled={loading} className="px-4 py-2 rounded-xl bg-slate-900 text-white w-full">
              {loading ? "Menyimpan..." : "Simpan password"}
            </button>
          </form>
        </div>
      );
    }

    function AuthBox({ onLoggedIn }) {
      async function signInAsAnonymous(){
        const { error } = await supabase.auth.signInAnonymously();
        if(error) return alert(error.message);
        onLoggedIn&&onLoggedIn();
      }

      async function signInAdmin(){
        const email=prompt("Email admin:");
        if(!email) return;
        const password=prompt("Password:");
        if(!password) return;
        const { error }=await supabase.auth.signInWithPassword({ email, password });
        if(error) return alert(error.message);
        onLoggedIn&&onLoggedIn();
      }

      return (<div className="max-w-md mx-auto">
        <div className="p-6 bg-white rounded-2xl shadow text-center">
          <h1 className="text-xl font-bold mb-2">GarmentPay Hub</h1>
          <p className="text-slate-600 mb-4">Pilih mode masuk</p>
          <div className="flex flex-col gap-3">
            <button onClick={signInAsAnonymous} className="px-4 py-2 rounded-xl bg-slate-900 text-white">Masuk sebagai Karyawan (Tanpa Email)</button>
            <button onClick={signInAdmin} className="px-4 py-2 rounded-xl bg-slate-200">Masuk sebagai Admin (Email/Password)</button>
          </div>
        </div>
        <p className="text-xs text-slate-500 mt-3 text-center">Internal use only</p>
      </div>);
    }

    async function getCurrentProfile(){
      const { data: { user } } = await supabase.auth.getUser();
      if(!user) return null;
      const { data } = await supabase.from('profiles').select('*').eq('id', user.id).maybeSingle();
      return data;
    }

    // ... (fungsi AddWorkerForm, LinkAnonProfile, AdminView, KaryawanView tetap sama seperti yang kamu punya)
    // â†“â†“â†“ (biar ringkas, jangan hapus bagian lama kamu di bawah ini)
    // Tetap masukkan semua komponen seperti AddWorkerForm, LinkAnonProfile, AdminView, dan KaryawanView di sini

    function App(){
      const [profile,setProfile]=useState(null);
      const [ready,setReady]=useState(false);

      const params = getHashParams();
      const isRecovery = params?.type === "recovery" && params?.access_token;

      useEffect(()=>{ 
        (async()=>{ 
          const p=await getCurrentProfile(); 
          setProfile(p); 
          setReady(true); 
        })();
        const { data: sub } = supabase.auth.onAuthStateChange(async()=>{ 
          const p=await getCurrentProfile(); 
          setProfile(p); 
        });
        return ()=>sub.subscription.unsubscribe(); 
      },[]);

      async function logout(){ 
        await supabase.auth.signOut(); 
        setProfile(null); 
      }

      if(!ready) return <div className="p-6">Loading...</div>;
      if(isRecovery) return <ResetPasswordView onDone={async()=>setProfile(await getCurrentProfile())} />;
      if(!profile) return <AuthBox onLoggedIn={async()=>setProfile(await getCurrentProfile())}/>;

      return (
        <div>
          <div className="flex items-center justify-between mb-4">
            <div className="text-sm text-slate-600">
              Login sebagai: {profile.email||"ANON"} â€¢ Role: <b>{profile.role}</b>
              <div className="text-xs text-slate-500">UID: {profile.id}</div>
            </div>
            <button onClick={logout} className="px-3 py-2 rounded-xl bg-white shadow text-sm">Logout</button>
          </div>
          {profile.role==="admin"?<AdminView/>:<KaryawanView profile={profile}/>}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("app-root")).render(<App />);
  </script>
</body>
</html>
